<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body >
<a href="/logout">Logout</a>
<div id="main"> 
<button type='button' @click="methods.loadList" >load List</button>
	<form id="myForm">
		title:<input type="text" v-model="newTitle" len="10"><br>
		content:<input type="text" v-model="newContent" len="10"><br>
		<input type='button' @click="methods.addPost(newTitle,newContent)" value="add">
	</form>
<hr />
<div>
<ol>
	<li v-for="(item, index) in dat" :key="item.id">
		{{item.title}}
	<button type="button" @click="methods.readPost(item.id)">Read</button>
	<button type="button" v-if="role=='admin'" @click="methods.delPost(item.id)">刪</button>
	</li>
</ol>
</div>
<div>
	<h1>post Detail</h1>
	<hr/>
	<p>
	({{rec.id}})
	title: {{rec.title}}
	</p>
	<p>
	content: {{rec.content}}
	</p>
	<p>
		<A :href="'/uploads/'+rec.filename" target="_blank">download {{rec.filename}}</a>
	</p>
	<h2>Upload a File</h2>
	<form action="/api/upload" method="post" enctype="multipart/form-data">
		<input ref="fileInput" type="file" accept="image/png, image/jpeg, .pdf" @change="methods.handleFileChange" />
		<input type="button" value="Upload" :disabled="!selectedFile" @click="methods.uploadFile()">
	</form>
</div>
</div>
<script type="text/javascript">
const { createApp, ref, reactive, onMounted } = Vue;

app=createApp({
  setup() {
    const newTitle = ref('');
	const newContent = ref('');
	const role=ref('admin');
	const rec=ref({});
	const dat=ref([]);
	const selectedFile = ref(null);
	
	const methods={
		loadList: () => {
		  // This runs after the component is mounted to the DOM
			let url="/getPostsJson";
			//let that=this;
			fetch(url,{
				method: 'GET'
			})
			.then(function(res){return res.json(); }) //取得傳回值，轉為文字
			.then(function(json){
			console.log(json);
				dat.value=json;
			})
			
		},
		readPost: (id) => {
		  // This runs after the component is mounted to the DOM
			let url="/readPostJson/"+id;
			//let that=this;
			fetch(url,{
				method: 'GET'
			})
			.then(function(res){return res.json(); }) //取得傳回值，轉為文字
			.then(function(json){
			console.log(json);
				rec.value=json;
			})
			
		},	
		addPost: (title,content) => {
			//let that=this;
			const formData = new FormData();
			formData.append('title', title);
			formData.append('content', content);
			fetch('/addPost', {
				method: 'POST',
				body: formData
			})
			.then(response => response.text())
			.then(data => {
				console.log('Server response:', data);
				methods.loadList();
			})
			.catch(error => {
				console.error('Error:', error);
			});
		},
		delPost: (id) => {
			//let that=this;
			const URL="/delete/" +id;
			fetch(URL)
			.then(response => response.text())
			.then(data => {
				console.log('Server response:', data);
				methods.loadList();
			})
			.catch(error => {
				console.error('Error:', error);
			});
		},
		handleFileChange: (event) => {
			selectedFile.value = event.target.files[0];
		},		
		uploadFile: async () => {
			if (selectedFile.value) {
				const allowedTypes = ['image/png', 'image/jpeg', 'application/pdf'];
				if (!allowedTypes.includes(selectedFile.value.type)) {
					console.log('Invalid file type. Please upload a PNG, JPEG, or PDF.');
					selectedFile.value = null; // Clear the invalid file
				} else {
					console.log('Selected file:', selectedFile.value.name);
					console.log('rec id:', rec.value.id);
					// Further fetch processing
					const formData = new FormData();
					formData.append('uploadedFile', selectedFile.value); // 'file' is the field name your server expects
					formData.append('msg',rec.value.id); //the postID
					try {
						const response = await fetch('/api/upload', {
							method: 'POST',
							body: formData,
						});

						if (response.ok) {
							const data = await response.json();
							console.log('Upload successful:', data);
							// Handle success (e.g., clear selected file, show message)
							selectedFile.value = null;
							methods.readPost(rec.id);
						} else {
						  console.error('Upload failed:', response.statusText);
						  // Handle error
						}
					} catch (error) {
						console.error('Network error during upload:', error);
						// Handle network errors
					}
				}
			} else {
				console.log("No file selected.");
			}
		}
	}; //end of methods

	onMounted(() => {
	console.log('App mounted!');
		methods.loadList();
		console.log('App mounted! loadlist');
	});

    return { newTitle, newContent, rec, dat,role,selectedFile,methods};
  }
}).mount('#main');
</script>
</body></html>